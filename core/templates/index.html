{% extends "rcstats_base.html" %}

{% block title %}
RC-Stats
{% endblock %}

{% block description %}
RC-Stats is a racing community to track and share your RC race results.
{% endblock %}

{% block content %}

<div class="jumbotron">
  <div class="container">
    <img class="img-responsive" src="/static/img/logo.png"/>
    <p>TRCR Race Results</p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-12 well">
      <h3>NEW RC-Stats</h3>
      <a type="button" href="{% url 'userena_signup' %}" class="btn btn-success">Signup for rc-stats</a>
      <br/>
      <br/>
      <p>
        <b>Mobile friendly and race results mailed right to you.</b> This is a complete re-write of the original rc-stats site.
        <br/>
        New functionality:
      </p>
      <ul>
      <li>Automatic race uploads, no more gaps in race coverage.</li>
      <li>Mobile friendly, race results on any device.</li>
      <li>Email race results directly to your inbox.</li>
      </ul>
      <a type="button" href="{% url 'race-emails' %}" class="btn btn-success">Race results right to your inbox</a>
    </div>
  </div>

  <div class="row">
    {% if trackname != null %}
    <div class="col-md-12 well">
      <h3>
        <a href={% url 'koh-summary' trackname.id %}>
          <span class="glyphicon glyphicon-fire" aria-hidden="true"></span> King Of the Hill
        </a>
      </h3>
      <p>Where do you stand in the rankings?</p>
      <a type="button" class="btn btn-info" href={% url 'koh-summary' trackname.id %}>King Of the Hill</a>
    </div>
    {% endif %}
  </div>

  <div class="row">
    {% if trackname != null %}
    <div class="col-md-12 well">
      <h3>
        <a href={% url 'racer-list-by-track' trackname.id %}>
          <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Racer List
        </a>
      </h3>
      <p>View {{ trackname.trackname }} racers and all the events for a specific racer.</p>
      <a type="button" class="btn btn-info" href={% url 'racer-list-by-track' trackname.id %}>{{ trackname.trackname }} Racer List</a>
    </div>
    {% endif %}
  </div>

  <div class="row">
    {% if singleracedetail != null %}
    <div class="col-md-12 well">
      <h2><a href={% url 'results-singleracedetail' singleracedetail.id %}>Newest Race</a></h2>
      <a type="button" class="btn btn-info" href={% url 'results-singleracedetail' singleracedetail.id %}>{{ singleracedetail.racedata }} {{ singleracedetail.maineventparsed }}</a>

      <div id="span-new-race-{{ singleracedetail.id }}"></div>
      <table id="table-new-race-{{ singleracedetail.id }}"></table>
    </div>
    {% endif %}
  </div>
  <div class="row">
    <div class="col-md-12 well">
      <h2>Recent Races</h2>
      <h3>{{ trackname.trackname }}</h3>
      <div class="alert alert-info" role="alert">
        <p>Select a row to navigate to that race</p>
      </div>
      <table id="table-all-races-{{ trackname.id }}"></table>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}

{% if singleracedetail != null %}
<script src="/static/js/rcstats.js"></script>
<script type="text/javascript" charset="utf-8">

$(document).ready(function(){
  populateSingleRaceFromRestEndpoint("{% url 'singleracedetailsbytrack-detail' trackname=trackname.id pk=singleracedetail.id  %}", {{ singleracedetail.id }});
});

//console.log("Data for the graph:", raceData);
$("#table-all-races-" + {{ trackname.id }}).bootstrapTable({
  //data: raceData,
  pagination: "true",
  pageSize: 25,
  url: "{% url 'singleracedetailslim-list' trackname=trackname.id %}",
  sidePagination: "server",
  responseHandler: function(rawRaceData) {
    // TODO - this is gross/hacky - FIX ME
   raceData = rawRaceData.results;

   var raceDataFormated = _.map(raceData, function(race) {
     var racedate = moment(race.racedate);
     var formatedRace = "";
     racedate.local();
     // Reference - http://momentjs.com/docs/#/displaying/
     formatedDate = racedate.format("MMM/D dddd h:mm");
     race.racedate = formatedDate;
     return race;
   });

   rawRaceData.total = rawRaceData.count;
   rawRaceData.rows = raceDataFormated;
    return rawRaceData;
  },
  onClickRow: function (row) {
      console.log('Event: onClickRow, data: ' + JSON.stringify(row));
      window.location.href = "{% url 'results-singleracedetail' '1111111' %}".replace("1111111", row.id)
  },
  columns: [{
      field: "id",
      title: "",
      visible: false
  }, {
      field: "racedata",
      title: "Class"
  }, {
      field: "maineventparsed",
      title: "Event"
  }, {
      field: "roundnumber",
      title: "Rnd"
  }, {
      field: "racenumber",
      title: "Num",
  }, {
      field: "racedate",
      title: "Date"
  }]
});

</script>
{% endif %}

{% endblock %}
