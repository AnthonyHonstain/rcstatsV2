{% extends "rcstats_base.html" %}

{% block title %}
RC-Stats
{% endblock %}

{% block description %}
RC-Stats is a racing community to track and share your RC race results.
{% endblock %}

{% block content %}

<div class="jumbotron">
  <div class="container">
    <img class="img-responsive" src="/static/img/logo.png"/>
    <p>RC Racing Community.</p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-12 well">
      <h2>NEW RC-Stats</h2>
      <p>
        <b>Mobile friendly and email updates</b>. This is a complete re-write of the original rc-stats site.
        <br/>
        New functionality:
      </p>
      <ul>
      <li>Automatic race uploads, no more gaps in race coverage.</li>
      <li>Mobile friendly, race results on any device.</li>
      <li>Email race results directly to your inbox.</li>
      </ul>
      <a type="button" href="{% url 'userena_signup' %}" class="btn btn-success">Free signup - choose the classes you want to follow.</a>
    </div>
  </div>
  <div class="row">
    {% if singleracedetail != null %}
    <div class="col-md-6 well">
      <h2>Newest Race</h2>
      <div id="span-new-race-{{ singleracedetail.id }}"></div>
      <table id="table-new-race-{{ singleracedetail.id }}"></table>
    </div>
    {% endif %}


    <div class="col-md-6 well">
      <h2>Recent Races</h2>
      <h3>{{ trackname.trackname }}</h3>
      <table id="table-all-races-{{ trackname.id }}"></table>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}

{% if singleracedetail != null %}
<script src="/static/js/rcstats.js"></script>
<script type="text/javascript" charset="utf-8">

$(document).ready(function(){
  populateSingleRaceFromRestEndpoint("{% url 'singleracedetailsbytrack-detail' trackname=trackname.id pk=singleracedetail.id  %}", {{ singleracedetail.id }});
});

//console.log("Data for the graph:", raceData);
$("#table-all-races-" + {{ trackname.id }}).bootstrapTable({
  //data: raceData,
  pagination: "true",
  url: "{% url 'singleracedetailslim-list' trackname=trackname.id %}",
  sidePagination: "server",
  responseHandler: function(rawRaceData) {
    // TODO - this is gross/hacky - FIX ME
   raceData = rawRaceData.results;

   var raceDataFormated = _.map(raceData, function(race) {
     var racedate = moment(race.racedate);
     var formatedRace = "";
     racedate.local();
     // Reference - http://momentjs.com/docs/#/displaying/
     formatedDate = racedate.format("MMM/D dddd h:mm");
     race.racedate = formatedDate;
     return race;
   });

   rawRaceData.total = rawRaceData.count;
   rawRaceData.rows = raceDataFormated;
    return rawRaceData;
  },
  onClickRow: function (row) {
      console.log('Event: onClickRow, data: ' + JSON.stringify(row));
      window.location.href = "{% url 'results-singleracedetail' '1111111' %}".replace("1111111", row.id)
  },
  columns: [{
      field: "id",
      title: "",
      visible: false
  }, {
      field: "racedata",
      title: "Class"
  }, {
      field: "roundnumber",
      title: "Rnd"
  }, {
      field: "racedate",
      title: "Date"
  }]
});

</script>
{% endif %}

{% endblock %}
